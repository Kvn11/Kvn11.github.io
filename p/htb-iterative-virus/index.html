<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Solution for the HackTheBox RE Challenge Iterative Virus"><title>HTB Iterative Virus</title>
<link rel=canonical href=https://Kvn11.github.io/p/htb-iterative-virus/><link rel=stylesheet href=/scss/style.min.0304c6baf04e01a8fe70693791cb744d56a3578a3120a8796cefc66825aa39c7.css><meta property='og:title' content="HTB Iterative Virus"><meta property='og:description' content="Solution for the HackTheBox RE Challenge Iterative Virus"><meta property='og:url' content='https://Kvn11.github.io/p/htb-iterative-virus/'><meta property='og:site_name' content='Kvn11'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='reverse'><meta property='article:tag' content='htb'><meta property='article:tag' content='medium'><meta property='article:tag' content='malware'><meta property='article:tag' content='windows'><meta property='article:published_time' content='2023-09-12T02:45:01-07:00'><meta property='article:modified_time' content='2023-09-12T02:45:01-07:00'><meta property='og:image' content='https://Kvn11.github.io/p/htb-iterative-virus/img/hackthebox.jpg'><meta name=twitter:title content="HTB Iterative Virus"><meta name=twitter:description content="Solution for the HackTheBox RE Challenge Iterative Virus"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://Kvn11.github.io/p/htb-iterative-virus/img/hackthebox.jpg'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hudbb421f81ae9f6f59107818afbf2d835_34334_300x0_resize_q75_box.JPG width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Kvn11</a></h1><h2 class=site-description>Trying to become IRL netrunner</h2></div></header><ol class=menu-social><li><a href=https://github.com/Kvn11 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#initial-analysis>Initial Analysis</a></li><li><a href=#reversing-with-ida-free>Reversing with IDA Free</a></li><li><a href=#lessons-learned>Lessons Learned</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/htb-iterative-virus/><img src=/p/htb-iterative-virus/img/hackthebox_hud104239935165a44571788a9c3d01fba_34890_800x0_resize_q75_box.jpg srcset="/p/htb-iterative-virus/img/hackthebox_hud104239935165a44571788a9c3d01fba_34890_800x0_resize_q75_box.jpg 800w, /p/htb-iterative-virus/img/hackthebox_hud104239935165a44571788a9c3d01fba_34890_1600x0_resize_q75_box.jpg 1600w" width=800 height=450 loading=lazy alt="Featured image of post HTB Iterative Virus"></a></div><div class=article-details><header class=article-category><a href=/categories/hackthebox/>HackTheBox</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/htb-iterative-virus/>HTB Iterative Virus</a></h2><h3 class=article-subtitle>Solution for the HackTheBox RE Challenge Iterative Virus</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Sep 12, 2023</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>5 minute read</time></div></footer></div></header><section class=article-content><blockquote><p><strong>Challenge Description</strong>: While cleaning up the workspace of a recently retired employee, we noticed that one of the core files of the very important programs they were working on didn&rsquo;t match up with the backups we have of it, could you check it out for us?</p></blockquote><h2 id=initial-analysis>Initial Analysis</h2><p>Upon running the executable, nothing out of the ordinary seemed to happen.
The <code>.exe</code> printed &ldquo;Hello World!&rdquo; and exited normally.
<code>PEBear</code> showed that there was another strange section in the exe file called <code>.ivir</code>.
I made the assumption that this was a reference to <code>I terative VIRus</code>, and the entry point being in this section further reinforced my theory that this was the &ldquo;virus&rdquo; part of the file.
The time stamp was set to <code>deadc0de</code> which was also strange, since that translates to a date well into the future.</p><p><img src=/p/htb-iterative-virus/img/img_1.png width=1038 height=523 srcset="/p/htb-iterative-virus/img/img_1_hu35f29c00fe042e3450b010407551f812_42024_480x0_resize_box_3.png 480w, /p/htb-iterative-virus/img/img_1_hu35f29c00fe042e3450b010407551f812_42024_1024x0_resize_box_3.png 1024w" loading=lazy alt="PE Bear analysis" class=gallery-image data-flex-grow=198 data-flex-basis=476px></p><h2 id=reversing-with-ida-free>Reversing with IDA Free</h2><p>The first interesting function to look at is one that returns a function name based on a number it is given.
It uses stack strings to prevent analysis tools from detecting the string as a string.
We can right click on the hex values to convert them to characters.
The result name is then passed to another function that seems to return a function pointer.
This made me think that the exe was dynamically resolving functions.</p><p><img src=/p/htb-iterative-virus/img/img_2.PNG width=484 height=705 srcset="/p/htb-iterative-virus/img/img_2_hu0c19397b28ef6f5773be28e20b8e7a0b_37887_480x0_resize_box_3.PNG 480w, /p/htb-iterative-virus/img/img_2_hu0c19397b28ef6f5773be28e20b8e7a0b_37887_1024x0_resize_box_3.PNG 1024w" loading=lazy alt="Dynamic Resolving Function 1" class=gallery-image data-flex-grow=68 data-flex-basis=164px></p><p>After we sort through each function call and match up the result, we can see the functions that have been resolved:</p><p><img src=/p/htb-iterative-virus/img/img_3.PNG width=1426 height=340 srcset="/p/htb-iterative-virus/img/img_3_hu5aab81d97e2caa4fce51f034348e4220_37172_480x0_resize_box_3.PNG 480w, /p/htb-iterative-virus/img/img_3_hu5aab81d97e2caa4fce51f034348e4220_37172_1024x0_resize_box_3.PNG 1024w" loading=lazy alt="Dynamic Resolving Function 2" class=gallery-image data-flex-grow=419 data-flex-basis=1006px></p><p>After these functions have been resolved, there is a value 5 bytes after the entry point that is compared.
If the value is 5, then a function is called.
However, this function seems to be broken, encrypted, or heavily obfuscated since the disassembly doesn&rsquo;t seem valid.
Otherwise, what seems like a key value is chosen and saved.</p><p><img src=/p/htb-iterative-virus/img/img_4.PNG width=671 height=488 srcset="/p/htb-iterative-virus/img/img_4_hu97d836c2e9435e68c7c5d6d84c7f93af_18847_480x0_resize_box_3.PNG 480w, /p/htb-iterative-virus/img/img_4_hu97d836c2e9435e68c7c5d6d84c7f93af_18847_1024x0_resize_box_3.PNG 1024w" loading=lazy alt="Key Values" class=gallery-image data-flex-grow=137 data-flex-basis=330px></p><p>Then the exe will iterate over all the <code>*.exe</code> files in its current directory, confirm some checks, and if everything looks good it will perform some actions on the current <code>.exe</code> file.
The main check is that the timestamp of the file needs to be set to <code>THIS</code> otherwise the infection of the file will not take place.</p><p><img src=/p/htb-iterative-virus/img/img_5.PNG width=733 height=279 srcset="/p/htb-iterative-virus/img/img_5_hucbbb156f379a41ebc5b60fa14a48910c_24109_480x0_resize_box_3.PNG 480w, /p/htb-iterative-virus/img/img_5_hucbbb156f379a41ebc5b60fa14a48910c_24109_1024x0_resize_box_3.PNG 1024w" loading=lazy alt="Infection Checks" class=gallery-image data-flex-grow=262 data-flex-basis=630px></p><p>Most the proceeding infection process isn&rsquo;t super important, and was in fact pretty tedious to look through and rename.
A new section and section header are added and modified to make sure they adhere to alignment rules, and the rest of the process is just copying over the infection code and making it so it replaces the entry point of the victim file.</p><p><img src=/p/htb-iterative-virus/img/img_6.PNG width=927 height=537 srcset="/p/htb-iterative-virus/img/img_6_huc09620f703d3c84eae24ae7156062fe9_62214_480x0_resize_box_3.PNG 480w, /p/htb-iterative-virus/img/img_6_huc09620f703d3c84eae24ae7156062fe9_62214_1024x0_resize_box_3.PNG 1024w" loading=lazy alt="Infection Process" class=gallery-image data-flex-grow=172 data-flex-basis=414px></p><p>The end of the process loops over the data from the broken function from earlier, and multiplies it against the key value selected earlier.
This new modified code is then copied into the victim file.
Then the byte 5 bytes ahead of the entry point is incremented and copied into the victim file.
This means when the newly infected victim exe is run, it will use the second key.
Then the next file to be infected will use the third key, and so on until the 4th iteration when that special byte is set to 5.
At that point the strange function from earlier runs.
This implies that after a certain number of infections the strange function reveals itself.
I verified most of this with dynamic analysis as well, but didn&rsquo;t take any screenshots.
If you want to verify with a debugger, set a breakpoint after the <code>MapViewOfFile</code> function and follow it in dump.
From there you can follow along with the exe code as it checks and modifies different parts of the victim file.</p><p><img src=/p/htb-iterative-virus/img/img_7.PNG width=870 height=136 srcset="/p/htb-iterative-virus/img/img_7_hu5bc4ae03addd6b8a46985ebcf02e61a2_10777_480x0_resize_box_3.PNG 480w, /p/htb-iterative-virus/img/img_7_hu5bc4ae03addd6b8a46985ebcf02e61a2_10777_1024x0_resize_box_3.PNG 1024w" loading=lazy alt="Decryption Process" class=gallery-image data-flex-grow=639 data-flex-basis=1535px></p><p>I ran the exe in <code>x64Dbg</code>, and copied out the encrypted code so I could manually decrypt it.
You could just manipulate the registers to do it all within <code>x64Dbg</code> but I ran into exceptions doing that so I opted for the python approach.
Here is the script that decrypts the flag function:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>code</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl><span class=mh>0xE25C0FE4937ECD98</span><span class=p>,</span> <span class=mh>0x46943D7D6211854C</span><span class=p>,</span> <span class=mh>0x7ED9FD7403244F3B</span><span class=p>,</span> <span class=mh>0x0954450DD34BC4FB</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mh>0x34738E7E3DC62246</span><span class=p>,</span> <span class=mh>0x382DF5BC3CDDD484</span><span class=p>,</span> <span class=mh>0x138529F69C81C398</span><span class=p>,</span> <span class=mh>0xE9FCF6D4DD85105E</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mh>0x5B977D744A5DBD4C</span><span class=p>,</span> <span class=mh>0xC2D93D4B963E5C85</span><span class=p>,</span> <span class=mh>0xB3DD747A06D5A985</span><span class=p>,</span> <span class=mh>0xD454843DE2F28EBF</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mh>0x0215CEB076580EDC</span><span class=p>,</span> <span class=mh>0x3F55D6792852AA4D</span><span class=p>,</span> <span class=mh>0x17AF0A0E48DDD484</span><span class=p>,</span> <span class=mh>0x547EA605BB8640AD</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mh>0x243D8A75B199B575</span><span class=p>,</span> <span class=mh>0x27D1C0EDAE5CB998</span><span class=p>,</span> <span class=mh>0x6108284AE5787878</span><span class=p>,</span> <span class=mh>0x7E49F4DF10792485</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mh>0xACD9F651E2F28EBF</span><span class=p>,</span> <span class=mh>0xADA04BA5BA8A1444</span><span class=p>,</span> <span class=mh>0xF77252CAFD2A38C9</span><span class=p>,</span> <span class=mh>0x388BB9FB9D000000</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mh>0x8CC468D4A37B0000</span><span class=p>,</span> <span class=mh>0x891DB54E4E4ABD4C</span><span class=p>,</span> <span class=mh>0xEFCE883F2C030000</span><span class=p>,</span> <span class=mh>0x399F79C914778100</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mh>0xB5B1F45FAD045A5C</span><span class=p>,</span> <span class=mh>0xB721A6D9B394FF4C</span><span class=p>,</span> <span class=mh>0xB0DE9DB43DD7A1B3</span><span class=p>,</span> <span class=mh>0xCC3AF2334A813038</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mh>0x3DD6D4E506470273</span><span class=p>,</span> <span class=mh>0x339B093AB6A0F837</span><span class=p>,</span> <span class=mh>0x3E997481AE05CCA5</span><span class=p>,</span> <span class=mh>0x689018943160B8AC</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mh>0xE35AE4EDCF035760</span><span class=p>,</span> <span class=mh>0x6D46B194A1A37B36</span><span class=p>,</span> <span class=mh>0x3619E5691F021894</span><span class=p>,</span> <span class=mh>0x0AFD79C343528DEC</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mh>0x0F7FEA94A59656C0</span><span class=p>,</span> <span class=mh>0x8DAE5CB998000000</span><span class=p>,</span> <span class=mh>0x1770879F9859C398</span><span class=p>,</span> <span class=mh>0x28B283C42B81C398</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mh>0x7B7B67D3051D07B1</span><span class=p>,</span> <span class=mh>0xBFE4C34F82F76B75</span><span class=p>,</span> <span class=mh>0x1B6CED770BFBA985</span><span class=p>,</span> <span class=mh>0xB8E5061F67130000</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mh>0x953D7B885F773041</span><span class=p>,</span> <span class=mh>0x1C206CC310CA422A</span><span class=p>,</span> <span class=mh>0x87130CC425BC4A04</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>KEY_1</span> <span class=o>=</span> <span class=mh>0x6E2368B9C685770B</span>
</span></span><span class=line><span class=cl><span class=n>KEY_2</span> <span class=o>=</span> <span class=mh>0xEB7FD64E061C1A3D</span>
</span></span><span class=line><span class=cl><span class=n>KEY_3</span> <span class=o>=</span> <span class=mh>0xCB8FF2D53D7505A1</span>
</span></span><span class=line><span class=cl><span class=n>KEY_4</span> <span class=o>=</span> <span class=mh>0xF1EF554206DCE4D</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>reverse_hex_string</span><span class=p>(</span><span class=n>h</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>h</span><span class=p>),</span> <span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>h</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>2</span><span class=p>]</span> <span class=o>+</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>print_blob</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>c</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>hex_string</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>v</span><span class=si>:</span><span class=s2>016X</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>+=</span> <span class=n>reverse_hex_string</span><span class=p>(</span><span class=n>hex_string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>code</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>code</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=n>key</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>decrypt</span><span class=p>(</span><span class=n>KEY_1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>decrypt</span><span class=p>(</span><span class=n>KEY_2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>decrypt</span><span class=p>(</span><span class=n>KEY_3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>decrypt</span><span class=p>(</span><span class=n>KEY_4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>print_blob</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Attempting to analyze this decrypted code didn&rsquo;t yield any results, so I figured it required the context of the full program to work successfully.
At this point I used <code>HxD</code> to patch the virus exe to overwrite the encrypted code with the decrypted one.
Then I opened it in IDA and saw that the decrypted code was also resolving more functions dynamically, although these function&rsquo;s aren&rsquo;t too important as the flag is visible in plaintext at this point.
The functions would open up a message box containing the flag value I think.</p><p><img src=/p/htb-iterative-virus/img/img_8.PNG width=908 height=508 srcset="/p/htb-iterative-virus/img/img_8_hub606f63516ba7f29a44885b8f590a99b_47164_480x0_resize_box_3.PNG 480w, /p/htb-iterative-virus/img/img_8_hub606f63516ba7f29a44885b8f590a99b_47164_1024x0_resize_box_3.PNG 1024w" loading=lazy alt=Flag class=gallery-image data-flex-grow=178 data-flex-basis=428px></p><h2 id=lessons-learned>Lessons Learned</h2><p>I spent much more time on this challenge than I should have.
A lot of time was wasted on reversing the exact infection process and seeing what fields were being changed in the headers of the victim file.
I should have focused on the decryption portion and the code surrounding that instead.
All in all, I think for next time I should focus less on the details and more so on the &ldquo;bigger picture&rdquo; of what the application is doing.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/reverse/>Reverse</a>
<a href=/tags/htb/>Htb</a>
<a href=/tags/medium/>Medium</a>
<a href=/tags/malware/>Malware</a>
<a href=/tags/windows/>Windows</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/kernel-adventures-part-ii/><div class=article-image><img src=https://i.pinimg.com/originals/d8/73/c9/d873c94e242bafe6bbcfa83cde3b8b42.jpg loading=lazy data-key data-hash=https://i.pinimg.com/originals/d8/73/c9/d873c94e242bafe6bbcfa83cde3b8b42.jpg></div><div class=article-details><h2 class=article-title>Kernel Adventures Part II</h2></div></a></article><article class=has-image><a href=/p/htb-pwn-pixel-audio/><div class=article-image><img src=/p/htb-pwn-pixel-audio/img/hackthebox.a8564f6acab257e4e2c3fcbb7fce82b4_hud104239935165a44571788a9c3d01fba_34890_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post HTB PWN Pixel Audio" data-hash="md5-qFZPasqyV+Tiw/y7f86CtA=="></div><div class=article-details><h2 class=article-title>HTB PWN Pixel Audio</h2></div></a></article><article class=has-image><a href=/p/htb-rev-challenge-ffmodule/><div class=article-image><img src=/p/htb-rev-challenge-ffmodule/img/hackthebox.a8564f6acab257e4e2c3fcbb7fce82b4_hud104239935165a44571788a9c3d01fba_34890_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post HTB REV Challenge FFModule" data-hash="md5-qFZPasqyV+Tiw/y7f86CtA=="></div><div class=article-details><h2 class=article-title>HTB REV Challenge FFModule</h2></div></a></article><article class=has-image><a href=/p/htb-web-prying-eyes/><div class=article-image><img src=/p/htb-web-prying-eyes/img/hackthebox.a8564f6acab257e4e2c3fcbb7fce82b4_hud104239935165a44571788a9c3d01fba_34890_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post HTB WEB Prying Eyes" data-hash="md5-qFZPasqyV+Tiw/y7f86CtA=="></div><div class=article-details><h2 class=article-title>HTB WEB Prying Eyes</h2></div></a></article><article class=has-image><a href=/p/htb-hw-challenge-trace/><div class=article-image><img src=/p/htb-hw-challenge-trace/img/hackthebox.a8564f6acab257e4e2c3fcbb7fce82b4_hud104239935165a44571788a9c3d01fba_34890_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post HTB HW Challenge Trace" data-hash="md5-qFZPasqyV+Tiw/y7f86CtA=="></div><div class=article-details><h2 class=article-title>HTB HW Challenge Trace</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//https-kvn11-github-io.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 Kvn11</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>