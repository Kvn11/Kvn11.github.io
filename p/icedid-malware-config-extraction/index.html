<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Unpacking and analyzing a IcedID malware sample"><title>IcedID Malware config extraction</title>
<link rel=canonical href=https://Kvn11.github.io/p/icedid-malware-config-extraction/><link rel=stylesheet href=/scss/style.min.0304c6baf04e01a8fe70693791cb744d56a3578a3120a8796cefc66825aa39c7.css><meta property='og:title' content="IcedID Malware config extraction"><meta property='og:description' content="Unpacking and analyzing a IcedID malware sample"><meta property='og:url' content='https://Kvn11.github.io/p/icedid-malware-config-extraction/'><meta property='og:site_name' content='Kvn11'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='malware'><meta property='article:tag' content='reversing'><meta property='article:tag' content='windows'><meta property='article:published_time' content='2023-12-01T02:45:01-07:00'><meta property='article:modified_time' content='2023-12-01T02:45:01-07:00'><meta property='og:image' content='https://Kvn11.github.io/p/icedid-malware-config-extraction/img/cover.jpg'><meta name=twitter:title content="IcedID Malware config extraction"><meta name=twitter:description content="Unpacking and analyzing a IcedID malware sample"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://Kvn11.github.io/p/icedid-malware-config-extraction/img/cover.jpg'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hudbb421f81ae9f6f59107818afbf2d835_34334_300x0_resize_q75_box.JPG width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Kvn11</a></h1><h2 class=site-description>Trying to become IRL netrunner</h2></div></header><ol class=menu-social><li><a href=https://github.com/Kvn11 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#sample-info>Sample Info</a></li><li><a href=#initial-analysis>Initial Analysis</a></li><li><a href=#unpacking>Unpacking</a><ol><li><a href=#callback-function>Callback function</a></li><li><a href=#decryption>Decryption</a></li></ol></li><li><a href=#dumped-pe>Dumped PE</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/icedid-malware-config-extraction/><img src=/p/icedid-malware-config-extraction/img/cover_hu2a9a7507b16ac1277fd064f96fac5ec6_49860_800x0_resize_q75_box.jpg srcset="/p/icedid-malware-config-extraction/img/cover_hu2a9a7507b16ac1277fd064f96fac5ec6_49860_800x0_resize_q75_box.jpg 800w, /p/icedid-malware-config-extraction/img/cover_hu2a9a7507b16ac1277fd064f96fac5ec6_49860_1600x0_resize_q75_box.jpg 1600w" width=800 height=577 loading=lazy alt="Featured image of post IcedID Malware config extraction"></a></div><div class=article-details><header class=article-category><a href=/categories/malware/>Malware</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/icedid-malware-config-extraction/>IcedID Malware config extraction</a></h2><h3 class=article-subtitle>Unpacking and analyzing a IcedID malware sample</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Dec 01, 2023</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>10 minute read</time></div></footer></div></header><section class=article-content><h2 id=sample-info>Sample Info</h2><p><a class=link href=https://bazaar.abuse.ch/sample/0581f0bf260a11a5662d58b99a82ec756c9365613833bce8f102ec1235a7d4f7/ target=_blank rel=noopener>0581f0bf260a11a5662d58b99a82ec756c9365613833bce8f102ec1235a7d4f7</a></p><h2 id=initial-analysis>Initial Analysis</h2><p>Based on the few number of imports, and the size of the <code>.data</code> section, this sample is likely packed.</p><p><img src=/p/icedid-malware-config-extraction/img/1.png width=347 height=216 srcset="/p/icedid-malware-config-extraction/img/1_hu255b867e81cdd1e8e185420027246aaa_3569_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/1_hu255b867e81cdd1e8e185420027246aaa_3569_1024x0_resize_box_3.png 1024w" loading=lazy alt="Why so little imports?" class=gallery-image data-flex-grow=160 data-flex-basis=385px> <img src=/p/icedid-malware-config-extraction/img/2.png width=727 height=205 srcset="/p/icedid-malware-config-extraction/img/2_hubc1cad610922c751ddb0116b9095aedb_7093_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/2_hubc1cad610922c751ddb0116b9095aedb_7093_1024x0_resize_box_3.png 1024w" loading=lazy alt="Sus data" class=gallery-image data-flex-grow=354 data-flex-basis=851px></p><h2 id=unpacking>Unpacking</h2><p>Unpacking proved to be more difficult than expected.
None of my breakpoints every got reached because my debugger exited before ever reaching the sample&rsquo;s entry point.
Additionally, after <code>x64dbg</code>&rsquo;s call to <code>LoadLibraryW</code> to load the sample, I could see that the sample had some memory reserved, but none of it&rsquo;s sections were mapped.
I figured it was probably receiving the wrong reason from the calling process and this was an anti analysis feature.
But then after looking at <code>PE-Bear</code> a lil more I realized that this <code>DLL</code> has a number of exports, so I could just use <code>rundll.exe</code> to call the functions manually and pass this obstacle.</p><p><img src=/p/icedid-malware-config-extraction/img/3.png width=485 height=179 srcset="/p/icedid-malware-config-extraction/img/3_hu708130b302a993688ca264c0cc7d003f_4862_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/3_hu708130b302a993688ca264c0cc7d003f_4862_1024x0_resize_box_3.png 1024w" loading=lazy alt="Exported functions from the Dll" class=gallery-image data-flex-grow=270 data-flex-basis=650px></p><p>After the dll is loaded in <code>x64dbg</code>, I just set breakpoints on each of the exported functions.</p><p><img src=/p/icedid-malware-config-extraction/img/4.png width=1248 height=150 srcset="/p/icedid-malware-config-extraction/img/4_hu170abdabdf5855104ad8dd7b5693693f_18516_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/4_hu170abdabdf5855104ad8dd7b5693693f_18516_1024x0_resize_box_3.png 1024w" loading=lazy alt=Breakpoints class=gallery-image data-flex-grow=832 data-flex-basis=1996px></p><p>When continuing, the first breakpoints I hit is the first function I called, <code>DllRegisterServer</code>.
This function was filled with instructions like <code>cmp al, al; jne</code> which were interesting because I don&rsquo;t think the jump would ever trigger.
My thought is that this was supposed to be an anti analysis technique.
Also, I quickly realized that debugging without knowing what I was looking for would be confusing and not very fruitful so I went back to binja to do some static analysis.
However, due to the fake branching, the code is a bit convuluted and hard to follow.
I decided to make a script to get rid of them.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>is_fake_cmp</span><span class=p>(</span><span class=n>instr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>instr</span><span class=o>.</span><span class=n>tokens</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>text</span> <span class=o>==</span> <span class=s2>&#34;cmp&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>op1</span> <span class=o>=</span> <span class=n>instr</span><span class=o>.</span><span class=n>tokens</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>op2</span> <span class=o>=</span> <span class=n>instr</span><span class=o>.</span><span class=n>tokens</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>op1</span><span class=o>.</span><span class=n>text</span> <span class=o>==</span> <span class=n>op2</span><span class=o>.</span><span class=n>text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>is_jump</span><span class=p>(</span><span class=n>instr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>instr</span><span class=o>.</span><span class=n>tokens</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>text</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&#34;je&#34;</span><span class=p>,</span> <span class=s2>&#34;jne&#34;</span><span class=p>,</span> <span class=s2>&#34;jz&#34;</span><span class=p>,</span> <span class=s2>&#34;jnz&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>find_fake_jmps</span><span class=p>(</span><span class=n>basic_block</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>fake_jmps</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>instructions</span> <span class=o>=</span> <span class=n>basic_block</span><span class=o>.</span><span class=n>get_disassembly_text</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ctr</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>ctr</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>instructions</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>instr</span> <span class=o>=</span> <span class=n>instructions</span><span class=p>[</span><span class=n>ctr</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>is_fake_cmp</span><span class=p>(</span><span class=n>instr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1>#print(f&#34;[i] Fake cmp @ 0x{instr.address:016X}&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>next_instr</span> <span class=o>=</span> <span class=n>instructions</span><span class=p>[</span><span class=n>ctr</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>is_jump</span><span class=p>(</span><span class=n>next_instr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] FOUND FAKE jump @ 0x</span><span class=si>{</span><span class=n>next_instr</span><span class=o>.</span><span class=n>address</span><span class=si>:</span><span class=s2>016X</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>fake_jmps</span><span class=o>.</span><span class=n>append</span><span class=p>(</span> <span class=p>(</span><span class=n>instr</span><span class=p>,</span> <span class=n>next_instr</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>ctr</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>ctr</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>fake_jmps</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>patch_fake_jmp</span><span class=p>(</span><span class=n>instr_pair</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cmp_instr</span> <span class=o>=</span> <span class=n>instr_pair</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>jmp_instr</span> <span class=o>=</span> <span class=n>instr_pair</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>jmp_type</span> <span class=o>=</span> <span class=n>jmp_instr</span><span class=o>.</span><span class=n>tokens</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>jmp_type</span> <span class=o>==</span> <span class=s2>&#34;je&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>bv</span><span class=o>.</span><span class=n>always_branch</span><span class=p>(</span><span class=n>jmp_instr</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>jmp_type</span> <span class=o>==</span> <span class=s2>&#34;jne&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>bv</span><span class=o>.</span><span class=n>never_branch</span><span class=p>(</span><span class=n>jmp_instr</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>jmp_type</span> <span class=o>==</span> <span class=s2>&#34;jz&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>bv</span><span class=o>.</span><span class=n>always_branch</span><span class=p>(</span><span class=n>jmp_instr</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>jmp_type</span> <span class=o>==</span> <span class=s2>&#34;jnz&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>bv</span><span class=o>.</span><span class=n>never_branch</span><span class=p>(</span><span class=n>jmp_instr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[!] Unhandled jmp @ 0x</span><span class=si>{</span><span class=n>jmp_instr</span><span class=o>.</span><span class=n>address</span><span class=si>:</span><span class=s2>016X</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=n>bv</span><span class=o>.</span><span class=n>convert_to_nop</span><span class=p>(</span><span class=n>cmp_instr</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>remove_fake_branches</span><span class=p>(</span><span class=n>fn_addr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>n_patched</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span> <span class=o>=</span> <span class=n>bv</span><span class=o>.</span><span class=n>get_function_at</span><span class=p>(</span><span class=n>fn_addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>basic_block</span> <span class=ow>in</span> <span class=n>f</span><span class=o>.</span><span class=n>basic_blocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>fake_jmps</span> <span class=o>=</span> <span class=n>find_fake_jmps</span><span class=p>(</span><span class=n>basic_block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>fj</span> <span class=ow>in</span> <span class=n>fake_jmps</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>patch_fake_jmp</span><span class=p>(</span><span class=n>fj</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>n_patched</span> <span class=o>+=</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>bv</span><span class=o>.</span><span class=n>begin_undo_actions</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>remove_fake_branches</span><span class=p>(</span><span class=mh>0x7ffd00e31000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>bv</span><span class=o>.</span><span class=n>commit_undo_actions</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>Also, from reading this <a class=link href=https://binary.ninja/2023/11/13/obfuscation-flare-on.html target=_blank rel=noopener>article</a> you will need to disable <code>Tail Call Analysis</code> in whatever tool you are using, otherwise, the psuedo c view will not be as concise as it could be.
And just like that, the control flow becomes so much easier to read.
Ngl, seeing this happen in real time was very satisfying.</p><p><img src=/p/icedid-malware-config-extraction/img/5.png width=250 height=908 srcset="/p/icedid-malware-config-extraction/img/5_hu01f062533f9732c7e45e256f225ddc72_9966_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/5_hu01f062533f9732c7e45e256f225ddc72_9966_1024x0_resize_box_3.png 1024w" loading=lazy alt=Before class=gallery-image data-flex-grow=27 data-flex-basis=66px> <img src=/p/icedid-malware-config-extraction/img/6.png width=461 height=729 srcset="/p/icedid-malware-config-extraction/img/6_hu7df3c03cfc00fab6ad101d34e7f33174_3656_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/6_hu7df3c03cfc00fab6ad101d34e7f33174_3656_1024x0_resize_box_3.png 1024w" loading=lazy alt=After class=gallery-image data-flex-grow=63 data-flex-basis=151px></p><p>If we follow the function calls in this now super flattened function, we end up at what looks to be a function that does some api hashing, and uses stack strings.
I set breakpoints at these calls so I could figure out what api it was grabbing.</p><p><img src=/p/icedid-malware-config-extraction/img/7.png width=580 height=904 srcset="/p/icedid-malware-config-extraction/img/7_hud069344d5fa12ff8093eb6e3db7704b0_124608_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/7_hud069344d5fa12ff8093eb6e3db7704b0_124608_1024x0_resize_box_3.png 1024w" loading=lazy alt="Main code" class=gallery-image data-flex-grow=64 data-flex-basis=153px> <img src=/p/icedid-malware-config-extraction/img/8.png width=728 height=178 srcset="/p/icedid-malware-config-extraction/img/8_hu0bc76c6a497de1d0d59a223c83ec6ad5_20761_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/8_hu0bc76c6a497de1d0d59a223c83ec6ad5_20761_1024x0_resize_box_3.png 1024w" loading=lazy alt="Looks like it wants to do something with a window?" class=gallery-image data-flex-grow=408 data-flex-basis=981px></p><p>I also found a check where the malware will only run its attack if the year is <code>2022</code>.
I ended up patching this instruction to always jump in <code>x64dbg</code>.
<code>EnumWindows</code> accepts a callback function, which is a prime candidate for inserting a malicous function, so I decided to explore that next.</p><h3 id=callback-function>Callback function</h3><p>Again, this function has a lot of fake branches, so prune those first.
The callback function seems to just get a handle to a windows, then it enters a function that seems to be doing some type of memory copying operations.</p><p><img src=/p/icedid-malware-config-extraction/img/9.png width=543 height=303 srcset="/p/icedid-malware-config-extraction/img/9_huf227c3ced8365a1cce63fc2ccf44b83b_22090_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/9_huf227c3ced8365a1cce63fc2ccf44b83b_22090_1024x0_resize_box_3.png 1024w" loading=lazy alt="Maybe COM injection?" class=gallery-image data-flex-grow=179 data-flex-basis=430px> <img src=/p/icedid-malware-config-extraction/img/10.png width=815 height=907 srcset="/p/icedid-malware-config-extraction/img/10_hu5447177a1eea6341be61c562312ef216_96364_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/10_hu5447177a1eea6341be61c562312ef216_96364_1024x0_resize_box_3.png 1024w" loading=lazy alt="Maybe this is the unpacking routine?" class=gallery-image data-flex-grow=89 data-flex-basis=215px></p><p>Following along some of the function calls results in finding what seems to be a promising function.
It seems to create a string <code>|SPL|</code>
Doing some OSINT reveals that this might be an IoC for <code>SplPacker</code>.</p><p><img src=/p/icedid-malware-config-extraction/img/11.png width=825 height=624 srcset="/p/icedid-malware-config-extraction/img/11_hudc81d96d09dbec768134a7d4a5021c5f_76254_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/11_hudc81d96d09dbec768134a7d4a5021c5f_76254_1024x0_resize_box_3.png 1024w" loading=lazy alt=" What is SPL?" class=gallery-image data-flex-grow=132 data-flex-basis=317px></p><p>There is also a string <code>DllRegisterServer</code> that is created dynamically, so thats something else to watch out for.
Since it seems that this is modifying memory and potentially unpacking something, I figured it might be easier at this point to just reverse this part dynamically.
Also, Binja isn&rsquo;t correctly deducing the function calls to these resolved APIs, so we need to define them ourselves and then change their type.
We can do this by creating new types:</p><p><img src=/p/icedid-malware-config-extraction/img/12.png width=715 height=577 srcset="/p/icedid-malware-config-extraction/img/12_huff7c79d00c601bdcb7c25892699f338c_25396_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/12_huff7c79d00c601bdcb7c25892699f338c_25396_1024x0_resize_box_3.png 1024w" loading=lazy alt=" All the calls just need to follow this pattern " class=gallery-image data-flex-grow=123 data-flex-basis=297px></p><p>I quickly arrive at a function that is doing some type of hashing.
It doesn&rsquo;t specify what type of hashing to do, so the process will use the default value, which I am unsure of what it would be.
ChatGPT says this would be using <code>PROV_RSA_FULL</code>.</p><p><img src=/p/icedid-malware-config-extraction/img/13.png width=740 height=733 srcset="/p/icedid-malware-config-extraction/img/13_hu66444dfd47d9c9d7f9ff6312457ddb22_97919_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/13_hu66444dfd47d9c9d7f9ff6312457ddb22_97919_1024x0_resize_box_3.png 1024w" loading=lazy alt=" Hashing function? " class=gallery-image data-flex-grow=100 data-flex-basis=242px></p><p>When stepping through <code>x64dbg</code>, I saw it was using <code>ALG_ID</code> of <code>8003</code> which corresponds to md5.
Also, I am able to obtain a few more hashes:</p><p><img src=/p/icedid-malware-config-extraction/img/14.png width=680 height=98 srcset="/p/icedid-malware-config-extraction/img/14_hud2e5b0d3f022614b54d09826e154658d_17997_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/14_hud2e5b0d3f022614b54d09826e154658d_17997_1024x0_resize_box_3.png 1024w" loading=lazy alt=" More hashes obtained. " class=gallery-image data-flex-grow=693 data-flex-basis=1665px></p><p>Also, as I stepped through some of the functions I found what looked to be RC4 encryption algo.
This assumption was based on the fact that it had 3 loops, each with 256 iterations, which matches up with the profile of RC4.</p><p><img src=/p/icedid-malware-config-extraction/img/15.png width=1064 height=912 srcset="/p/icedid-malware-config-extraction/img/15_hu3201af0a0d80690875d8c0c4f84a82e2_144270_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/15_hu3201af0a0d80690875d8c0c4f84a82e2_144270_1024x0_resize_box_3.png 1024w" loading=lazy alt=" RC4 " class=gallery-image data-flex-grow=116 data-flex-basis=280px></p><h3 id=decryption>Decryption</h3><p>There are 2 references to this RC4 function, so I labeled them as potential decryption functions.
In both of these references, a key of <code>0x11c742c6</code> is used.
There is also another function that does some type of encryption or encoding using the same data, key, and key length, although I wasn&rsquo;t able to understand it at the time.
Additionally, from the references to the data and key, I was able to deduce that the code is using this structure:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>data_block</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>PVOID</span> <span class=n>pdata</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>data_len</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>It passes references to this structure to its encryption routines.</p><p><img src=/p/icedid-malware-config-extraction/img/16.png width=1303 height=620 srcset="/p/icedid-malware-config-extraction/img/16_hu2ffb72f1c754a302111291b414786e32_100807_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/16_hu2ffb72f1c754a302111291b414786e32_100807_1024x0_resize_box_3.png 1024w" loading=lazy alt=" Not sure what this does " class=gallery-image data-flex-grow=210 data-flex-basis=504px></p><p>At this point, I felt that it would be easier to see how these functions are used from <code>x64dbg</code>, so I went back to it.
I ended up putting an access breakpoint on the data section, so i could see when the hex strings start getting used.
Through this method I was able to figure out the following chunk of data was some type of metadata about the hexstream in the <code>.data</code> section.</p><p><img src=/p/icedid-malware-config-extraction/img/17.png width=809 height=150 srcset="/p/icedid-malware-config-extraction/img/17_hu64dd6e961fe7e970af5fd94bd963d4e5_22705_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/17_hu64dd6e961fe7e970af5fd94bd963d4e5_22705_1024x0_resize_box_3.png 1024w" loading=lazy alt=" Metadata before the hex stream " class=gallery-image data-flex-grow=539 data-flex-basis=1294px></p><p>Also, the hex stream is converted from hex to bytes, and then copies into the section created by <code>NtCreateSection</code> earlier in the process.
Then the data is hashed several times, maybe to verify its integerity.
It was also at this point where I realized that the function that I had thought to be encoding was actually a second type of decryption that is applied to the data after it has been passed through the RC4 routine.
The strategy I used to do this was to check for instructions that moved data from either a stack variable or process memory to a register or vice versa.
Another hint was that this also used the same parameters as the RC4 function.
Then you see the operations that are done upon it.
The authors of this malware use an obfuscation technique in this encryption where they add values, and then subtract them, essentially restoring the original value.
The obfuscated formula for the xor encryption is:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>data[i] = (data[i] ^ key[i % len(key)])
</span></span><span class=line><span class=cl>data[i] -= data[i + 1]
</span></span><span class=line><span class=cl>data[i] += 0x100 - 0x100
</span></span><span class=line><span class=cl>data[i] += (i % len(key)) &amp; 0xFF
</span></span><span class=line><span class=cl>data[i] -= (i % len(key)) &amp; 0xFF 
</span></span></code></pre></td></tr></table></div></div><p>which simplifies down to:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>data[i] = (data[i] ^ key[i % len(key)]) - data[i + 1]
</span></span></code></pre></td></tr></table></div></div><p>Because python treats the operands of these operations as signed integers we also need to add a mask of <code>0xFF</code> to cut the resulting byte/s to the right size.</p><p>We can copy these unpacking process in binary ninja with the following script:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>binaryninja</span> <span class=kn>import</span> <span class=n>Transform</span><span class=p>,</span> <span class=n>BinaryReader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ADDR_OF_DATA</span> <span class=o>=</span> <span class=mh>0x7fff7a1a9040</span>
</span></span><span class=line><span class=cl><span class=n>KEY</span> <span class=o>=</span> <span class=mh>0x11c742c6</span>
</span></span><span class=line><span class=cl><span class=n>FILENAME</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_data</span><span class=p>(</span><span class=n>hexstream_addr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>br</span> <span class=o>=</span> <span class=n>BinaryReader</span><span class=p>(</span><span class=n>bv</span><span class=p>,</span> <span class=n>address</span><span class=o>=</span><span class=n>hexstream_addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>curr</span> <span class=o>=</span> <span class=n>br</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>curr</span> <span class=o>!=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00\x00</span><span class=s2>&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>+=</span> <span class=n>curr</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>curr</span> <span class=o>=</span> <span class=n>br</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rc4_decrypt</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=n>KEY</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=n>byteorder</span><span class=o>=</span><span class=s2>&#34;little&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rc4</span> <span class=o>=</span> <span class=n>Transform</span><span class=p>[</span><span class=s2>&#34;RC4&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>rc4</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=p>{</span><span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=n>key</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>xor_decrypt</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=n>KEY</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=n>byteorder</span><span class=o>=</span><span class=s2>&#34;little&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>^</span> <span class=n>key</span><span class=p>[</span><span class=n>i</span> <span class=o>%</span> <span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>-=</span> <span class=n>data</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>&amp;=</span> <span class=n>b</span> <span class=o>&amp;</span> <span class=mh>0xFF</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>unpack</span><span class=p>(</span><span class=n>hexstream_addr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>get_data</span><span class=p>(</span><span class=n>hexstream_addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>rc4_decrypt</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>xor_decrypt</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>FILENAME</span><span class=p>,</span> <span class=s2>&#34;wb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>unpack</span><span class=p>(</span><span class=n>ADDR_OF_DATA</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>This script leaves us with a big ole dump file.
But it is progress :)</p><p>If we go back to binja with all the new information we picked up from dynamic analysis, and and follow what happens after this decryption function is called, we will see that the unpacked data is parsed for the string &ldquo;|SPL|&rdquo;.</p><p><img src=/p/icedid-malware-config-extraction/img/18.png width=989 height=478 srcset="/p/icedid-malware-config-extraction/img/18_hu7972a14cf3447531a8b81997dfe99dfa_64848_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/18_hu7972a14cf3447531a8b81997dfe99dfa_64848_1024x0_resize_box_3.png 1024w" loading=lazy alt=" Searching for |SPL| " class=gallery-image data-flex-grow=206 data-flex-basis=496px></p><p>If we search for this value ourselves, we can see that it is used as a seperator.
There are 5 payloads that are in this dump.</p><p><img src=/p/icedid-malware-config-extraction/img/19.png width=854 height=464 srcset="/p/icedid-malware-config-extraction/img/19_hu6e5ec128f7c0e2028edff70a17ce1629_17869_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/19_hu6e5ec128f7c0e2028edff70a17ce1629_17869_1024x0_resize_box_3.png 1024w" loading=lazy alt=" 5 for the price of 1 " class=gallery-image data-flex-grow=184 data-flex-basis=441px></p><p>I placed each in <code>HxD</code> and used their magic bytes to determine what they are.
The first is some stub code that was jumped to from the main process.
I saw this in <code>x64dbg</code> when tracking the <code>NtCreateSection</code> api call.
The second one might be a compressed PE file, cuz I can see a PE header, but I&rsquo;ll analyze that in Binja soon.
The third is a full PE file.
Windows defender was able to recognize it as malware, so this is probably the payload the contains the config we want.
Section 4 was a <code>.jfif</code> file, that contain an image of a lion emblem.
I&rsquo;ll do some analysis on that in a bit in case it contains anything interesting inside the image.
Section 5 was a jpeg of a drawing of a woman.</p><p><img src=/p/icedid-malware-config-extraction/img/20.png width=1606 height=865 srcset="/p/icedid-malware-config-extraction/img/20_hua3591544d217a252851246f630cacb17_1028268_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/20_hua3591544d217a252851246f630cacb17_1028268_1024x0_resize_box_3.png 1024w" loading=lazy alt="Interesting pics" class=gallery-image data-flex-grow=185 data-flex-basis=445px></p><h2 id=dumped-pe>Dumped PE</h2><p>This PE is a lot easier to read.
It will immediately create a thread, with <code>THREAD_CREATE_RUN_IMMEDIATELY</code>.
There is a call to <code>Sleep</code> which we can get rid of to speed up analysis.
Then we almost immediately hit the decryption routine that reveals the C2 address we have been hunting for.</p><p><img src=/p/icedid-malware-config-extraction/img/21.png width=953 height=407 srcset="/p/icedid-malware-config-extraction/img/21_hubfdf2eebe96be33098ff2a201f8ee941_46718_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/21_hubfdf2eebe96be33098ff2a201f8ee941_46718_1024x0_resize_box_3.png 1024w" loading=lazy alt=" Call to decryption routine" class=gallery-image data-flex-grow=234 data-flex-basis=561px> <img src=/p/icedid-malware-config-extraction/img/22.png width=672 height=433 srcset="/p/icedid-malware-config-extraction/img/22_huf2da2a7fae5eeab6e8388d8e7c6b2b99_34011_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/22_huf2da2a7fae5eeab6e8388d8e7c6b2b99_34011_1024x0_resize_box_3.png 1024w" loading=lazy alt=" Simple XOR " class=gallery-image data-flex-grow=155 data-flex-basis=372px></p><p>In this case it was: <code>ilekvoyn.com</code>.
Continuing through the code, it becomes clear that it is crafting a URL request to this address.
It uses a cookie value obtained early from querying something in our kernel.
Then adds in the result of <code>GetSysCount64</code> / 1000, then adds in some other values.
Since this is a quick challenge, and an old sample I did not bother seeing what how the value was being generated, but I can assume safely assume it&rsquo;s likely something unique to our infection.</p><p><img src=/p/icedid-malware-config-extraction/img/23.png width=1106 height=404 srcset="/p/icedid-malware-config-extraction/img/23_hu432940433aa376f036172f82063f2f5f_69117_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/23_hu432940433aa376f036172f82063f2f5f_69117_1024x0_resize_box_3.png 1024w" loading=lazy alt="Cookie string creation" class=gallery-image data-flex-grow=273 data-flex-basis=657px> <img src=/p/icedid-malware-config-extraction/img/24.png width=467 height=61 srcset="/p/icedid-malware-config-extraction/img/24_hue59f29b484e086b960b375cc4050b73c_1654_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/24_hue59f29b484e086b960b375cc4050b73c_1654_1024x0_resize_box_3.png 1024w" loading=lazy alt="My special cookie" class=gallery-image data-flex-grow=765 data-flex-basis=1837px></p><p>Anyways, the goal of this challenge was to unpack and grab the c2 address, and we have enough information to do that.
We just need to combine our unpacking script with the string decryption, and we should be good.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>binaryninja</span> <span class=kn>import</span> <span class=n>BinaryReader</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>xor_decrypt</span><span class=p>(</span><span class=n>data_addr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>br</span> <span class=o>=</span> <span class=n>BinaryReader</span><span class=p>(</span><span class=n>bv</span><span class=p>,</span> <span class=n>address</span><span class=o>=</span><span class=n>data_addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>br</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mh>0x20</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>config</span> <span class=o>+=</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>^</span> <span class=n>data</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mh>0x40</span><span class=p>])</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;little&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>config</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>extract_url_from_bytes</span><span class=p>(</span><span class=n>byte_string</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>extracted_ascii</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>byte</span> <span class=ow>in</span> <span class=n>byte_string</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=mi>32</span> <span class=o>&lt;=</span> <span class=n>byte</span> <span class=o>&lt;=</span> <span class=mi>126</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>extracted_ascii</span> <span class=o>+=</span> <span class=nb>bytes</span><span class=p>([</span><span class=n>byte</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>extracted_ascii</span> <span class=o>=</span> <span class=n>extracted_ascii</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pattern</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=s1>&#39;.*com&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=n>pattern</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>extracted_ascii</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>url</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=n>config</span> <span class=o>=</span> <span class=n>xor_decrypt</span><span class=p>(</span><span class=mh>0x7ffc97718000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span> <span class=n>extract_url_from_bytes</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] C2 Address -&gt; </span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/icedid-malware-config-extraction/img/25.png width=686 height=71 srcset="/p/icedid-malware-config-extraction/img/25_hue54092cb6e7962d1293af356ed0736fa_6094_480x0_resize_box_3.png 480w, /p/icedid-malware-config-extraction/img/25_hue54092cb6e7962d1293af356ed0736fa_6094_1024x0_resize_box_3.png 1024w" loading=lazy alt=" Finished " class=gallery-image data-flex-grow=966 data-flex-basis=2318px></p><p>I could have automated the entirety of this, but its an old sample so I don&rsquo;t wanna put a ton of effort into something that may only be valid for this sample, so instead I&rsquo;ll move onto a fresh upload, maybe agent tesla :D</p><p>You can find all the scripts I used <a class=link href=https://github.com/Kvn11/scripts/tree/main target=_blank rel=noopener>HERE</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/malware/>Malware</a>
<a href=/tags/reversing/>Reversing</a>
<a href=/tags/windows/>Windows</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/pikabot-malware-analysis/><div class=article-image><img src=/p/pikabot-malware-analysis/img/cover.c53bf014814f414dc626c31bcf6ee6e8_hu7e43340f20ef237573ca21eeae8912fa_89734_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Pikabot malware analysis" data-hash="md5-xTvwFIFPQU3GJsMbz27m6A=="></div><div class=article-details><h2 class=article-title>Pikabot malware analysis</h2></div></a></article><article class=has-image><a href=/p/gozi-malware-unpacking-and-config-extraction/><div class=article-image><img src=/p/gozi-malware-unpacking-and-config-extraction/img/cover.f6c29aa98da4ac391fbba7cc20cf8437_hufd045887b53cb3360ed141f9d234bb22_75842_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Gozi malware unpacking and config extraction" data-hash="md5-9sKaqY2krDkfu6fMIM+ENw=="></div><div class=article-details><h2 class=article-title>Gozi malware unpacking and config extraction</h2></div></a></article><article class=has-image><a href=/p/windows-shellcode-loader-in-c/><div class=article-image><img src=/p/windows-shellcode-loader-in-c/img/cover.04ad87212effd547017c4894622dd80a_hu2b7ef2eb33007bfd8f3ce0e8fba06270_1162734_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Windows Shellcode Loader in C" data-hash="md5-BK2HIS7/1UcBfEiUYi3YCg=="></div><div class=article-details><h2 class=article-title>Windows Shellcode Loader in C</h2></div></a></article><article class=has-image><a href=/p/htb-rev-challenge-ffmodule/><div class=article-image><img src=/p/htb-rev-challenge-ffmodule/img/hackthebox.a8564f6acab257e4e2c3fcbb7fce82b4_hud104239935165a44571788a9c3d01fba_34890_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post HTB REV Challenge FFModule" data-hash="md5-qFZPasqyV+Tiw/y7f86CtA=="></div><div class=article-details><h2 class=article-title>HTB REV Challenge FFModule</h2></div></a></article><article class=has-image><a href=/p/htb-iterative-virus/><div class=article-image><img src=/p/htb-iterative-virus/img/hackthebox.a8564f6acab257e4e2c3fcbb7fce82b4_hud104239935165a44571788a9c3d01fba_34890_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post HTB Iterative Virus" data-hash="md5-qFZPasqyV+Tiw/y7f86CtA=="></div><div class=article-details><h2 class=article-title>HTB Iterative Virus</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//https-kvn11-github-io.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 Kvn11</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>